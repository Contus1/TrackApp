<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TrackApp Browser Diagnostics</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            max-width: 800px;
            margin: 40px auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            min-height: 100vh;
        }
        .container {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            padding: 30px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        h1 {
            text-align: center;
            margin-bottom: 30px;
            font-size: 2.5em;
        }
        .test-section {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
            border: 1px solid rgba(255, 255, 255, 0.15);
        }
        .test-section h3 {
            margin-top: 0;
            color: #ffeb3b;
        }
        .status {
            display: inline-block;
            padding: 5px 15px;
            border-radius: 25px;
            font-weight: bold;
            margin-left: 10px;
            font-size: 0.9em;
        }
        .status.success { background: #4caf50; color: white; }
        .status.error { background: #f44336; color: white; }
        .status.warning { background: #ff9800; color: white; }
        button {
            background: linear-gradient(45deg, #ff6b6b, #feca57);
            border: none;
            color: white;
            padding: 12px 25px;
            border-radius: 25px;
            cursor: pointer;
            font-weight: bold;
            margin: 10px 5px;
            transition: transform 0.2s;
        }
        button:hover {
            transform: translateY(-2px);
        }
        .result {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            padding: 15px;
            margin: 10px 0;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            overflow-x: auto;
        }
        .fix-suggestions {
            background: rgba(255, 193, 7, 0.2);
            border: 1px solid rgba(255, 193, 7, 0.5);
            border-radius: 10px;
            padding: 15px;
            margin: 15px 0;
        }
        .fix-suggestions h4 {
            margin-top: 0;
            color: #ffeb3b;
        }
        .solution {
            background: rgba(76, 175, 80, 0.2);
            border: 1px solid rgba(76, 175, 80, 0.5);
            border-radius: 10px;
            padding: 15px;
            margin: 15px 0;
        }
        .solution h4 {
            margin-top: 0;
            color: #4caf50;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🔧 TrackApp Browser Diagnostics</h1>
        
        <div class="test-section">
            <h3>Browser Information</h3>
            <div id="browser-info"></div>
        </div>

        <div class="test-section">
            <h3>Storage Tests</h3>
            <div>
                <strong>LocalStorage:</strong>
                <span id="localStorage-status" class="status">Testing...</span>
            </div>
            <div>
                <strong>SessionStorage:</strong>
                <span id="sessionStorage-status" class="status">Testing...</span>
            </div>
            <div>
                <strong>Cookies:</strong>
                <span id="cookies-status" class="status">Testing...</span>
            </div>
        </div>

        <div class="test-section">
            <h3>Network & CORS Tests</h3>
            <div>
                <strong>Fetch API:</strong>
                <span id="fetch-status" class="status">Testing...</span>
            </div>
            <div>
                <strong>Supabase URL:</strong>
                <span id="supabase-url-status" class="status">Testing...</span>
            </div>
            <button onclick="testSupabaseConnection()">Test Supabase Connection</button>
            <div id="supabase-result" class="result" style="display: none;"></div>
        </div>

        <div class="test-section">
            <h3>Authentication Tests</h3>
            <button onclick="testAuth()">Test Authentication Flow</button>
            <div id="auth-result" class="result" style="display: none;"></div>
        </div>

        <div class="test-section">
            <h3>Invite System Tests</h3>
            <button onclick="testInviteSystem()">Test Invite Storage</button>
            <div id="invite-result" class="result" style="display: none;"></div>
        </div>

        <div class="test-section">
            <h3>Quick Fixes</h3>
            <button onclick="clearAllData()">Clear All Browser Data</button>
            <button onclick="enableIncognito()">Try Incognito Mode</button>
            <button onclick="checkCORS()">Check CORS Issues</button>
        </div>

        <div id="suggestions" style="display: none;">
            <div class="fix-suggestions">
                <h4>🔧 Mögliche Lösungen:</h4>
                <ul id="fix-list"></ul>
            </div>
        </div>

        <div id="working-solution" style="display: none;">
            <div class="solution">
                <h4>✅ Das funktioniert:</h4>
                <p>Die App funktioniert in <strong>Inkognito-Modus</strong> und auf <strong>Mobile Chrome</strong>. Das Problem liegt wahrscheinlich an:</p>
                <ul>
                    <li>Browser-Cache oder gespeicherte Daten</li>
                    <li>Cookie-/Storage-Berechtigungen</li>
                    <li>Adblocker oder Browser-Erweiterungen</li>
                    <li>CORS-Einstellungen in Supabase</li>
                </ul>
            </div>
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://dbrohopvnpggcowfxpwo.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRicm9ob3B2bnBnZ2Nvd2Z4cHdvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzU5OTE5MzQsImV4cCI6MjA1MTU2NzkzNH0.X74nDWjkJd0g-x10O7K3dGNcKjnZmY9xPR9p7p6RtIs';

        // Browser Info
        function detectBrowser() {
            const ua = navigator.userAgent;
            let browser = 'Unknown';
            let version = 'Unknown';
            
            if (ua.includes('Chrome') && !ua.includes('Edg')) {
                browser = 'Chrome';
                const match = ua.match(/Chrome\/([0-9.]+)/);
                version = match ? match[1] : 'Unknown';
            } else if (ua.includes('Safari') && !ua.includes('Chrome')) {
                browser = 'Safari';
                const match = ua.match(/Version\/([0-9.]+)/);
                version = match ? match[1] : 'Unknown';
            } else if (ua.includes('Firefox')) {
                browser = 'Firefox';
                const match = ua.match(/Firefox\/([0-9.]+)/);
                version = match ? match[1] : 'Unknown';
            } else if (ua.includes('Edg')) {
                browser = 'Edge';
                const match = ua.match(/Edg\/([0-9.]+)/);
                version = match ? match[1] : 'Unknown';
            }
            
            return { browser, version };
        }

        function displayBrowserInfo() {
            const { browser, version } = detectBrowser();
            const isMobile = /Mobi|Android/i.test(navigator.userAgent);
            const isIncognito = 'chrome' in window && window.chrome.runtime && window.chrome.runtime.onConnect;
            
            document.getElementById('browser-info').innerHTML = `
                <div><strong>Browser:</strong> ${browser} ${version}</div>
                <div><strong>Mobile:</strong> ${isMobile ? 'Ja' : 'Nein'}</div>
                <div><strong>User Agent:</strong> ${navigator.userAgent}</div>
                <div><strong>Platform:</strong> ${navigator.platform}</div>
                <div><strong>Language:</strong> ${navigator.language}</div>
            `;
        }

        // Storage Tests
        function testStorage() {
            // LocalStorage Test
            try {
                localStorage.setItem('test', 'test');
                localStorage.removeItem('test');
                setStatus('localStorage-status', 'success', 'Funktioniert');
            } catch (e) {
                setStatus('localStorage-status', 'error', 'Blockiert: ' + e.message);
                addFix('LocalStorage ist blockiert - versuche Inkognito-Modus oder ändere Browser-Einstellungen');
            }

            // SessionStorage Test
            try {
                sessionStorage.setItem('test', 'test');
                sessionStorage.removeItem('test');
                setStatus('sessionStorage-status', 'success', 'Funktioniert');
            } catch (e) {
                setStatus('sessionStorage-status', 'error', 'Blockiert: ' + e.message);
                addFix('SessionStorage ist blockiert - prüfe Browser-Einstellungen');
            }

            // Cookies Test
            try {
                document.cookie = 'test=test; SameSite=Lax';
                const cookiesEnabled = document.cookie.includes('test=test');
                if (cookiesEnabled) {
                    setStatus('cookies-status', 'success', 'Funktioniert');
                    // Clean up
                    document.cookie = 'test=; expires=Thu, 01 Jan 1970 00:00:01 GMT;';
                } else {
                    setStatus('cookies-status', 'error', 'Blockiert');
                    addFix('Cookies sind blockiert - aktiviere sie in den Browser-Einstellungen');
                }
            } catch (e) {
                setStatus('cookies-status', 'error', 'Fehler: ' + e.message);
            }
        }

        // Network Tests
        function testNetwork() {
            if (typeof fetch !== 'undefined') {
                setStatus('fetch-status', 'success', 'Verfügbar');
            } else {
                setStatus('fetch-status', 'error', 'Nicht verfügbar');
                addFix('Fetch API nicht verfügbar - Browser zu alt');
            }

            // Test Supabase URL
            if (SUPABASE_URL && SUPABASE_URL.startsWith('https://')) {
                setStatus('supabase-url-status', 'success', 'Konfiguriert');
            } else {
                setStatus('supabase-url-status', 'error', 'Nicht konfiguriert');
                addFix('Supabase URL ist nicht richtig konfiguriert');
            }
        }

        async function testSupabaseConnection() {
            const resultDiv = document.getElementById('supabase-result');
            resultDiv.style.display = 'block';
            resultDiv.innerHTML = 'Testing Supabase connection...';

            try {
                const response = await fetch(`${SUPABASE_URL}/rest/v1/`, {
                    method: 'GET',
                    headers: {
                        'apikey': SUPABASE_ANON_KEY,
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    resultDiv.innerHTML = '✅ Supabase connection successful!\\nStatus: ' + response.status;
                } else {
                    resultDiv.innerHTML = '❌ Supabase connection failed\\nStatus: ' + response.status + '\\nResponse: ' + await response.text();
                    addFix('Supabase Verbindung fehlgeschlagen - prüfe CORS-Einstellungen');
                }
            } catch (error) {
                resultDiv.innerHTML = '❌ Network error: ' + error.message;
                addFix('Netzwerk-Fehler - prüfe Internetverbindung oder CORS-Blockierung');
            }
        }

        async function testAuth() {
            const resultDiv = document.getElementById('auth-result');
            resultDiv.style.display = 'block';
            resultDiv.innerHTML = 'Testing authentication...';

            try {
                // Create a minimal Supabase client simulation
                const response = await fetch(`${SUPABASE_URL}/auth/v1/signup`, {
                    method: 'POST',
                    headers: {
                        'apikey': SUPABASE_ANON_KEY,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        email: 'test@example.com',
                        password: 'testpassword123'
                    })
                });

                const data = await response.json();
                
                if (response.ok || response.status === 422) { // 422 is expected for duplicate email
                    resultDiv.innerHTML = '✅ Auth endpoint accessible\\nStatus: ' + response.status;
                } else {
                    resultDiv.innerHTML = '⚠️ Auth response: ' + response.status + '\\n' + JSON.stringify(data, null, 2);
                    if (response.status === 0) {
                        addFix('CORS-Fehler bei Authentication - prüfe Supabase Site URL Einstellungen');
                    }
                }
            } catch (error) {
                resultDiv.innerHTML = '❌ Auth test failed: ' + error.message;
                if (error.message.includes('fetch')) {
                    addFix('Fetch-Fehler bei Authentication - wahrscheinlich CORS-Problem');
                }
            }
        }

        function testInviteSystem() {
            const resultDiv = document.getElementById('invite-result');
            resultDiv.style.display = 'block';
            
            try {
                // Test invite storage
                const testInvite = {
                    token: 'test-token-' + Date.now(),
                    inviter_id: 'test-user',
                    invitee_email: 'test@example.com',
                    created_at: new Date().toISOString(),
                    expires_at: new Date(Date.now() + 7 * 24 * 60 * 60 * 1000).toISOString()
                };

                // Store invite
                const invites = JSON.parse(localStorage.getItem('pending_invites') || '[]');
                invites.push(testInvite);
                localStorage.setItem('pending_invites', JSON.stringify(invites));

                // Retrieve invite
                const storedInvites = JSON.parse(localStorage.getItem('pending_invites') || '[]');
                const foundInvite = storedInvites.find(inv => inv.token === testInvite.token);

                if (foundInvite) {
                    resultDiv.innerHTML = '✅ Invite system working\\nTest invite stored and retrieved successfully';
                    
                    // Clean up
                    const cleanedInvites = storedInvites.filter(inv => inv.token !== testInvite.token);
                    localStorage.setItem('pending_invites', JSON.stringify(cleanedInvites));
                } else {
                    resultDiv.innerHTML = '❌ Invite system failed\\nCould not retrieve stored invite';
                    addFix('Invite-System Problem - localStorage funktioniert nicht richtig');
                }
            } catch (error) {
                resultDiv.innerHTML = '❌ Invite test failed: ' + error.message;
                addFix('Invite-System Fehler: ' + error.message);
            }
        }

        // Helper functions
        function setStatus(elementId, type, text) {
            const element = document.getElementById(elementId);
            element.className = 'status ' + type;
            element.textContent = text;
        }

        const fixes = [];
        function addFix(fix) {
            if (!fixes.includes(fix)) {
                fixes.push(fix);
                updateSuggestions();
            }
        }

        function updateSuggestions() {
            const suggestionsDiv = document.getElementById('suggestions');
            const fixList = document.getElementById('fix-list');
            
            if (fixes.length > 0) {
                suggestionsDiv.style.display = 'block';
                fixList.innerHTML = fixes.map(fix => `<li>${fix}</li>`).join('');
            }
        }

        // Quick fix functions
        function clearAllData() {
            try {
                localStorage.clear();
                sessionStorage.clear();
                
                // Clear cookies
                document.cookie.split(";").forEach(function(c) { 
                    document.cookie = c.replace(/^ +/, "").replace(/=.*/, "=;expires=" + new Date().toUTCString() + ";path=/"); 
                });
                
                alert('✅ Browser-Daten gelöscht! Seite wird neu geladen...');
                setTimeout(() => window.location.reload(), 1000);
            } catch (error) {
                alert('❌ Fehler beim Löschen: ' + error.message);
            }
        }

        function enableIncognito() {
            document.getElementById('working-solution').style.display = 'block';
            alert('💡 Öffne die App in einem Inkognito-/Privaten Fenster:\\n\\n• Chrome: Strg+Shift+N (Cmd+Shift+N)\\n• Safari: Cmd+Shift+N\\n• Firefox: Strg+Shift+P (Cmd+Shift+P)');
        }

        function checkCORS() {
            alert('🌐 CORS-Probleme prüfen:\\n\\n1. Supabase Dashboard öffnen\\n2. Settings > API > Site URL prüfen\\n3. Sollte sein: ' + window.location.origin + '\\n4. Falls anders, aktualisieren und warten (~5 Min)');
        }

        // Initialize tests
        window.onload = function() {
            displayBrowserInfo();
            testStorage();
            testNetwork();
            
            // Show working solution hint
            setTimeout(() => {
                document.getElementById('working-solution').style.display = 'block';
            }, 2000);
        };
    </script>
</body>
</html>
